let globalData = {
    "姿势": {
        "坐": "sitting",
        "站": "stand",
        "蹲着": "squat",
        "趴": "grovel",
        "躺": "lie",
        "跳": "jump",
        "跑": "run",
        "走": "walk",
        "飞": "fly",
        "双手叉腰": "hands on hip"
    },
    "头发": {
        "短发": "short hair",
        "卷发": "curly hair",
        "长发": "long hair",
        "马尾": "pony-tail",
        "双马尾": "bunches",
        "挑染": "streaked hair",
        "灰色渐变": "grey gradient hair",
        "亮棕": "light brown hair",
        "双色": "two-tone hair",
        "五颜六色": "multicolored hair",
        "高马尾": "high ponytail",
        "双马尾": "twintails",
        "马尾编发": "braided ponytail ",
        "马尾辫": "ponytail",
        "短马尾": "short_ponytail",
        "双辫子": "twin_braids",
        "短发": "short hair",
        "中发": "medium hair",
        "长发": "long hair",
        "超长发": "very long hair",
        "辫子刘海": "braided bangs",
        "侧扫刘海": "swept bangs",
        "眼间头发": "hair between eyes",
        "妹妹切": "bob cut",
        "公主切": "hime_cut",
        "交叉刘海": "crossed bangs",
        "刘海": "bangs",
        "齐刘海": "blunt bangs",
        "翼状头发": "hair wings",
        "长刘海": "long bangs",
        "蓬发": "disheveled hair",
        "波浪形头发": "wavy hair",
        "卷发": "curly_hair",
        "收拢": "hair in takes",
        "发带": "scrunchie",
        "粉色花": "hair pink flowers",
        "呆毛": "ahoge",
        "多根呆毛": "antenna hair",
        "侧马尾": "Side ponytail",
        "露额头": "forehead",
        "钻头卷公主卷": "drill hair",
        "包子头": "hair bun",
        "俩包子头": "double_bun",
        "凌乱发型": "messy_hair"
    },
    "发色": {
        "白": "white hair",
        "金": "blonde hair ",
        "银": "silver hair",
        "灰": "grey hair ",
        "紫": "purple hair",
        "红": "red hair",
        "黄": "yellow hair",
        "绿": "green hair",
        "蓝": "blue hair",
        "黑": "black hair",
        "棕": "brown hair",
    },
    "衣服": {
        "晚礼服": "evening dress",
        "短裙": "Skirt",
        "长裙": "Long skirt",
        "水手服": "sailor suit",
        "JK": "JK",
        "黑色丝袜": "black silk stocking",
        "白色丝袜": "white silk stocking",
        "西装": "suit",
        "马靴": "riding boots",
        "吊带袜": "suspende",
        "湿衣服": "wet clothes",
        "发带": "hair lace",
        "比基尼": "bikini",
        "领子": "sailor collar",
        "帽子": "hat",
        "衬衫": "shirt",
        "水手服": "shorts under skirt",
        "有领衬衣": "collared shirt ",
        "学校制服": "school uniform",
        "日本学生服": "seifuku",
        "职场制服": "business_suit",
        "夹克": "jacket",
        "火焰纹章军服": "garreg mach monastery uniform",
        "礼服长裙": "revealing dress",
        "礼服": "pink lucency full dress",
        "露出胸口部分的连衣裙": "cleavage dress",
        "无袖连衣裙": "sleeveless dress",
        "白色连衣裙": "whitedress",
        "婚纱": "wedding_dress",
        "水手连衣裙": "Sailor dress",
        "毛衣裙": "sweater dress",
        "罗纹毛衣": "ribbed sweater",
        "毛衣夹克": "sweater jacket",
        "工装服": "dungarees",
        "棕色开襟衫（外套）": "brown cardigan ",
        "连帽衫，卫衣": "hoodie ",
        "长袍": "robe",
        "斗篷": "cape",
        "羊毛衫": "cardigan",
        "围裙": "apron",
        "哥特风格": "gothic",
        "洛丽塔风格": "lolita_fashion",
        "哥特洛丽塔风格": "gothic_lolita",
        "西部风格": "western",
        "格子花纹": "tartan",
        "露单肩": "off_shoulder",
        "露双肩": "bare_shoulders",
        "赤脚": "barefoot",
        "裸足": "bare_legs",
        "横条花纹的": "striped",
        "点状花纹的": "polka_dot",
        "皱边的": "frills",
        "花边": "lace",
        "日本女生运动短裤": "buruma",
        "运动服": "gym_uniform",
        "女用背心": "tank_top",
        "裁剪短夹克": "cropped jacket ",
        "运动胸罩": "black sports bra ",
        "漏脐装": "crop top",
        "睡衣": "pajamas",
        "和服": "japanese_clothes",
        "衣带和服用": "obi",
        "网眼上衣": "mesh",
        "无袖上衣": "sleeveless shirt",
        "袖肩分离装": "detached_sleeves",
        "白色灯笼裤": "white bloomers",
        "高腰腿裤": "high - waist shorts",
        "百褶裙": "pleated_skirt",
        "裙子": "skirt",
        "迷你裙": "miniskirt",
        "热裤": "short shorts",
        "夏日长裙": "summer_dress",
        "灯笼裤": "bloomers",
        "短裤": "shorts",
        "自行车短裤": "bike_shorts",
        "海豚短裤": "dolphin shorts",
        "腰带": "belt",
        "比基尼（前加颜色）": "bikini",
        "吊索比基尼": "sling bikini",
        "比基尼乳罩": "bikini_top",
        "上身比基尼": " bikini top only ",
        "侧边系带比基尼下装": "side - tie bikini bottom",
        "系带式比基尼": "side-tie_bikini",
        "褶边比基尼": "friled bikini",
        "比基尼内衣": " bikini under clothes",
        "泳装": "swimsuit",
        "学校泳衣": "school swimsuit",
        "连体泳衣": "one-piece swimsuit",
        "竞技泳衣": "competition swimsuit",
        "死库水": "Sukumizu",
        "没胸罩": "no bra",
        "胸罩": "bra ",
        "褶边文胸": "frilled bra ",
        "情趣内衣": "sexy lingerie",
        "透明内衣": "transparent underwear",
        "缠胸布": "sarashi",
        "胸衣": "bustier",
        "吊带胸衣": "chemise",
        "内衣": "underwear",
        "内裤（前加颜色）": "panties",
        "条纹内裤": "striped_panties",
        "没内裤": "no_panties",
        "低腰式内裤": "lowleg_panties/low_leg_panties",
        "侧系带内裤": "side-tie_panties",
        "高腰内裤": "string_panties",
        "丁字裤": "thong",
        "日式丁字裤": "fundoshi",
        "女用贴身内衣裤": "lingerie"
    },
    "鞋子": {
        "鞋子": "shoes ",
        "靴子": "boots",
        "乐福鞋": "loafers",
        "高跟鞋": "high heels",
        "系带靴": "cross-laced_footwear",
        "玛丽珍鞋": "mary_janes",
        "女式学生鞋": "uwabaki",
        "拖鞋": "slippers",
        "马靴": "knee_boots",
        "连裤袜": "pantyhose",
        "大腿连裤袜": "thighband pantyhose",
        "连腰吊带袜": "garter_belt",
        "吊带袜": "garter straps",
        "短袜": "socks",
        "横条袜": "striped_socks",
        "泡泡袜": "loose_socks",
        "裹腿": "legwear",
        "黑色紧身裤": "black leggings ",
        "裤袜": "leggings ",
        "网袜": "fishnets",
        "渔网袜": "fishnet_pantyhose",
        "长袜": "kneehighs",
        "丝袜": "stockings",
        "过膝袜": "thighhighs",
        "条纹过膝袜": "striped_thighhighs",
        "白色过膝袜": "white_thighhighs",
        "损坏了的过膝袜": "torn_thighhighs",
        "日式厚底短袜": "tabi",
        "蕾丝镶边紧身裤": "lace-trimmed legwear",
        "腿部花边环": "leg_garter",
        "腿部系带": "ankle_lace-up",
        "大腿系带": "thigh strap",
        "短裤下的紧身裤": "legwear under shorts"
    },
    "装饰": {
        "光环": "halo",
        "迷你礼帽": "mini_top_hat",
        "贝雷帽": "beret",
        "兜帽": "hood",
        "护士帽": "nurse cap",
        "皇冠": "tiara",
        "鬼角": "oni horns",
        "恶魔角": "demon horns",
        "发带": "hair_ribbon",
        "花丝带": "flower ribbon",
        "发卡": "hairband",
        "发夹": "hairclip",
        "发花": "hair_flower",
        "头饰": "hair_ornament",
        "蝴蝶结": "bowtie",
        "蝴蝶结发饰": "hair_bow",
        "女仆头饰": "maid_headdress",
        "服装饰品头部饰品": "bow",
        "发饰": "hair ornament",
        "心形": "heart hair ornament",
        "创可贴": "bandaid",
        "发包": "hair bun",
        "锥形发髻": "cone hair bun",
        "双发髻": "double bun",
        "半无框的眼镜": "semi-rimless eyewear",
        "太阳镜": "sunglasses",
        "风镜": "goggles",
        "眼罩独眼": "eyepatch",
        "黑色眼罩": "black blindfold",
        "耳机": "headphones",
        "面纱": "veil",
        "口罩": "mouth mask",
        "眼镜": "glasses",
        "耳环": "earrings",
        "首饰": "jewelry",
        "铃铛": "bell",
        "颈带": "ribbon_choker",
        "颈部饰品": "black choker ",
        "项链": "necklace",
        "耳机套脖子上": "headphones around neck",
        "项圈": "collar",
        "水手领": "sailor_collar",
        "领巾": "neckerchief",
        "领带": "necktie",
        "十字架": "cross necklace",
        "吊坠": "pendant",
        "珠宝": "jewelry",
        "围巾": "scarf",
        "臂章": "armband",
        "臂环": "armlet",
        "臂带": "arm strap",
        "肘部手套": "elbow gloves ",
        "露指手套": "half gloves ",
        "手镯": "bracelet",
        "手套": "gloves",
        "五指手套": "fingerless gloves",
        "锁链": "chains",
        "手链": "shackles",
        "手铐": "handcuffs",
        "手表": "wristwatch",
        "腕带": "wristband",
        "腕饰": "wrist_cuffs",
        "拿着书": "holding book",
        "拿着剑": "holding sword",
        "球拍": "tennis racket",
        "手杖": "cane",
        "双肩包": "backpack",
        "书包": "school bag ",
        "肩背书包": "satchel",
        "手机": "smartphone "
    },
    "胸": {
        "小": "small breast",
        "中": "medium breast",
        "大": "big breast"
    },
    "类型": {
        "女孩": "girl",
        "男孩": "boy",
        "御姐": "adult lady like woman"
    },
    "身份": {
        "女王": "queen",
        "学生": "student",
        "医生": "doctor",
        "护士": "nurse",
        "警察": "police",
        "士兵": "soldier",
        "骑士": "knight",
        "女仆": "housemaid",
        "天使": "angel",
        "啦啦队": "cheerleader",
        "版人物": "chibi",
        "伪娘": "trap",
        "魔鬼": "devil",
        "人偶": "doll",
        "妖精": "elf",
        "小精灵": "fairy",
        "女人": "female",
        "兽人": "furry",
        "半兽人": "orc",
        "女巨人": "giantess",
        "后宫": "harem",
        "偶像": "idol",
        "兽耳萝莉模式": "kemonomimi_mode",
        "萝莉": "loli",
        "魔法少女": "magical_girl",
        "男人": "male",
        "美人鱼": "mermaid",
        "巫女": "miko",
        "熟女": "milf",
        "迷你女孩": "minigirl",
        "怪物": "monster",
        "魔幻少女": "multiple_girls",
        "忍者": "ninja",
        "非人": "no_humans",
        "修女": "nun",
        "护士": "nurse",
        "正太": "shota",
        "空姐": "stewardess",
        "吸血鬼": "vampire",
        "女服务员": "waitress",
        "女巫": "witch",
        "搞基": "yaoi",
        "油库里": "yukkuri_shiteitte_ne",
        "百合": "yuri"
    },
    "表情": {
        "微笑": "smirk",
        "诱惑笑": "seductive smile",
        "露齿而笑": "grin",
        "笑": "laughing",
        "牙": "teeth ",
        "兴奋": "excited",
        "害羞": "nose blush ",
        "脸红": "blush",
        "无表情": "expressionless",
        "失神": "expressionless eyes",
        "困": "sleepy",
        "喝醉的": "drunk",
        "哭": "crying with eyes open",
        "悲伤的": "sad",
        "别扭努嘴": "pout",
        "叹气": "sigh",
        "睁大眼睛": "wide eyed",
        "生气": "angry",
        "苦恼的": "annoyed",
        "皱眉": "frown",
        "认真": "smirk",
        "严肃": "serious",
        "鄙夷": "jitome",
        "锐利": "scowl",
        "疯狂的": "crazy",
        "黑化的": "dark_persona",
        "得意": "smug",
        "调皮脸": "naughty_face",
        "一只眼睛闭上": "one eye closed",
        "半闭眼睛": "half-closed eyes",
        "鼻血": "nosebleed",
        "做鬼脸": "eyelid pull ",
        "舌头": "tongue",
        "吐舌": "tongue out",
        "闭嘴": "closed mouth",
        "张嘴": "open mouth",
        "口红": "lipstick",
        "尖牙": "fangs",
        "咬紧牙关": "clenched teeth",
        "ω猫嘴": ":3",
        "向下吐舌头": ":p",
        "向上吐舌头": ":q",
        "不耐烦": ":t",
        "杯型笑脸": ":d",
        "下流的表情": "naughty_face",
        "忍耐的表情": "endured_face",
        "阿黑颜": "ahegao",
        "血在脸上": "blood on face",
        "唾液": "saliva"
    },
    "二次元": {
        "食物在脸上（食物可替换）": "food on face",
        "淡淡腮红": "light blush",
        "面纹": "facepaint",
        "浓妆": "makeup ",
        "可爱表情": "cute face",
        "白色睫毛": "white colored eyelashes",
        "长睫毛": "longeyelashes",
        "白色眉毛": "white eyebrows",
        "吊眼角": "tsurime",
        "渐变眼": "gradient_eyes",
        "美丽的细节眼睛": "beautiful detailed eyes",
        "垂眼角": "tareme",
        "猫眼": "slit pupils ",
        "异色瞳": "heterochromia ",
        "红蓝眼": "heterochromia blue red",
        "水汪汪大眼": "aqua eyes",
        "看你": "looking at viewer",
        "盯着看": "eyeball",
        "凝视": "stare",
        "透过刘海看": "visible through hair",
        "看旁边": "looking to the side ",
        "收缩的瞳孔": "constricted pupils",
        "符号形状的瞳孔": "symbol-shaped pupils ",
        "❤": "heart in eye",
        "爱心瞳孔": "heart-shaped pupils",
        "眨眼": "wink ",
        "眼下痣": "mole under eye",
        "闭眼": "eyes closed",
        "没鼻子": "no_nose",
        "动物耳朵": "animal_ears",
        "动物耳绒毛": "animal ear fluff ",
        "狐狸耳朵": "fox_ears",
        "兔子耳朵": "bunny_ears",
        "猫耳": "cat_ears",
        "狗耳": "dog_ears",
        "叔耳": "mouse_ears",
        "头发上耳朵": "hair ear",
        "尖耳": "pointy ears"
    },
    "动作": {
        "歪头": "head tilt",
        "回头": "looking back",
        "向下看": "looking down",
        "向上看": "looking up",
        "闻": "smelling",
        "手放在嘴边": "hand_to_mouth",
        "手放头旁边": "arm at side ",
        "手放脑后": "arms behind head",
        "手放后面": "arms behind back ",
        "手放在自己的胸前": "hand on own chest",
        "手交叉于胸前": "arms_crossed",
        "手放臀": "hand on another\u0027s hip",
        "单手插腰": "hand_on_hip",
        "双手叉腰": "hands_on_hips",
        "举手": "hands up ",
        "伸懒腰": "stretch",
        "举手露腋": "armpits",
        "手把腿抓着": "leg hold",
        "抓住": "grabbing",
        "拿着": "holding",
        "用手指做出笑脸": "fingersmile",
        "拉头发": "hair_pull",
        "撮头发": "hair scrunchie",
        "手势": "w ",
        "耶": "peace symbol ",
        "翘大拇指": "thumbs_up",
        "比出中指": "middle_finger",
        "猫爪手势": "cat_pose",
        "手枪手势": "finger_gun",
        "嘘手势": "shushing",
        "招手": "waving",
        "敬礼": "salute",
        "张手": "spread_arms",
        "张开腿": "spread legs",
        "二郎腿": "crossed_legs",
        "曲腿至胸": "fetal_position",
        "抬一只脚": "leg_lift",
        "抬两只脚": "legs_up",
        "前倾": "leaning forward",
        "婴儿姿势": "fetal position",
        "靠墙": " against wall",
        "趴着": "on_stomach",
        "坐": "sitting on",
        "正坐": "seiza",
        "割坐": "wariza/w-sitting",
        "侧身坐": "yokozuwari",
        "盘腿": "indian_style",
        "抱腿": "leg_hug",
        "跨坐": "straddling",
        "下跪": "kneeling",
        "抽烟": "smoking",
        "用手支撑住": "arm_support",
        "": "caramelldansen",
        "公主抱": "princess_carry",
        "战斗姿态": "fighting_stance",
        "颠倒的": "upside-down",
        "趴着翘臀": "top-down_bottom-up",
        "翘臀姿势": "bent_over",
        "弓身体": "arched_back",
        "背对背": "back-to-back",
        "手对手": "symmetrical_hand_pose",
        "眼对眼（对视）": "eye_contact",
        "拥抱": "hug",
        "膝枕": "lap_pillow",
        "睡觉": "sleeping",
        "洗澡": "bathing",
        "掏耳勺": "mimikaki",
        "牵手": "holding_hands",
        "四肢趴地": "all_fours",
        "女胸部贴在一起": "symmetrical_docking",
        "脱衣服": "undressing",
        "掀起裙子": "skirt lift",
        "掀起上衣": "shirt lift",
        "调整过膝袜": "adjusting_thighhigh"
    },
    "露出": {
        "肩膀": "Bare shoulders",
        "大腿": "Bare thigh",
        "手臂": "Bare arms",
        "肚脐": "Bare navel"
    },
    "场景": {
        "海边": "seaside",
        "沙滩": "sandbeach",
        "树林": "grove",
        "城堡": "castle",
        "室内": "indoor",
        "床": "bed",
        "椅子": "chair",
        "窗帘": "curtain"
    },
    "物品": {
        "书": "book",
        "酒杯": "wine glass",
        "蝴蝶": "butterfly",
        "猫": "cat"
    },
    "妆容": {
        "猫耳": "cat ear",
        "猫尾": "cat tail"
    },
    "天气": {
        "白天": "day",
        "黄昏": "dusk",
        "夜晚": "night",
        "下雨": "rain",
        "雨中": "in the rain",
        "雨天": "rainy days",
        "日落": "sunset",
        "多云": "cloudy",
        "满月": "full_moon",
        "太阳": "sun",
        "落日": "sunset",
        "月亮": "moon",
    },
    "类型": {
        "单人": "solo",
        "多个": "multiple girls",
        "小女孩": "little girl",
        "小男孩": "little boy",
        "正太": "shota",
        "萝莉": "loli",
        "可爱": "kawaii",
        "雌小鬼": "mesugaki",
        "可爱的女孩": "adorable girl",
        "美少女": "bishoujo",
        "辣妹": "gyaru",
        "姐妹": "sisters",
        "大小姐": "ojousama",
        "成熟女性": "mature female",
        "成熟": "mature",
        "痴女": "female pervert",
        "熟女": "milf",
        "后宫": "harem"
    },
    "画质": {
        "格子的": "checkered",
        "低分辨率": "lowres",
        "高分辨率": "highres",
        "超高分辨率": "absurdres",
        "极高分辨率": "incredibly_absurdres",
        "超级高分辨率大文件": "huge_filesize",
        "壁纸": "wallpaper",
        "点阵图": "pixel_art",
        "单色图片": "monochrome",
        "色彩斑斓的": "colorful",
    },
    "风格": {
        "原画": "artbook",
        "游戏": "game_cg",
        "漫画": "comic",
        "四格": "4koma",
        "格式图片": "animated_gif",
        "抱枕": "dakimakura",
        "角色扮演": "cosplay",
        "穿越": "crossover",
        "暗的": "dark",
        "亮的": "light",
        "晚上": "night",
        "猎奇": "guro",
        "写实": "realistic",
        "照片": "photo",
        "真实": "real",
        "风景": "landscape/scenery",
        "城市风景": "cityscape",
        "科技幻想": "science_fiction",
        "原创": "original",
        "拙劣的模仿": "parody",
        "拟人": "personification",
        "视觉错误": "optical_illusion",
        "名画模仿": "fine_art_parody",
        "素描": "sketch",
        "传统媒体（基本上是手绘稿）": "traditional_media",
        "透明水彩绘": "watercolor_(medium)",
        "剪影": "silhouette",
        "封面": "covr",
        "专辑": "album",
        "图上有字样": "sample",
        "背影像": "back",
        "半身像": "bust",
        "侧面绘": "profile",
        "表情绘（各种表情）": "expressions",
        "一部作品中的主要人物集齐": "everyone",
        "一列列小图组成大图": "column_lineup",
        "透明的背景": "transparent_background",
        "简单的背景无背景": "simple_background",
        "渐变的背景": "gradient_background",
        "背景是前景的放大版": "zoom_layer"
    },
    "环境": {
        "天空": "sky",
        "大海": "sea",
        "星星": "stars",
        "山": "mountain",
        "山上": "on a hill",
        "山顶": "the top of the hill",
        "草地": "in a meadow",
        "高原": "plateau",
        "沙漠": "on a desert",
        "春": "in spring",
        "夏": "in summer",
        "秋": "in autumn",
        "冬": "in winter",
        "夏威夷": "in hawaii",
        "城市风景": "cityscape",
        "风景": "landscape",
        "好天": "beautiful detailed sky",
        "好水": "beautiful detailed water",
        "海滩上": "on the beach",
        "在大海上": "on the ocean",
        "海边上": "over the sea",
        "海边日落": "in the ocean",
        "傍晚背对阳光": "against backlight at dusk",
        "黄金时段照明": "golden hour lighting",
        "强边缘光": "strong rim light",
        "强阴影": "intense shadows"
    },
    "正面常用": {
        "高质量": "best quality",
        "高细节": "highly detailed"


    },
    "负面常用": {
        "lowres": "lowres",
        "bad anatomy": "bad anatomy",
        "bad hands": "bad hands",
        "text": "text",
        "error": "error",
        "missing fingers": "missing fingers",
        "extra digit": "extra digit",
        "ewer digits": "ewer digits",
        "cropped": "cropped",
        "worst quality": "worst quality",
        "low quality": "low quality",
        "normal quality": "normal quality",
        "jpeg artifacts": "jpeg artifacts",
        "signature": "signature",
        "watermark": "watermark",
        "username": "username",
        "blurry": "blurry",
    },

    "优秀实践": {
        "繁花草甸": "Flowery meadow",
        "秃积雨云": "cumulonimbus calvus",
        "鬃积雨云": "cumulonimbus capillatus",
        "璀璨星空": "Bright stars",
        "花丝带": "flower ribbon",
        "天使": "angel",
        "细节的水": "starry detailed water",
        "细节的天空": "beautiful detailed starry sky",
        "严肃": "serious",
        "动漫": "anime",
        "花丛": "flowering shrubs",
        "蒲公英": "dandelion",
        "向日葵": "sunflower"

    },
    "自定义": {
        "漂亮眼睛": "beautiful detailed eyes",
        "粉红长裙": "pink lucency full dress",
        "华丽": "gorgeous"
    }
};

function createElement(name, params) {
    let element = document.createElement(name);
    for (let key in params) {
        element.setAttribute(key, params[key]);
    }
    return element;
}

let must = [
    "正面常用", "负面常用"
];
let neg = [
    "负面常用"
];
var checkTab = null;
let myWeight = {};
let checkBoxs = [];
var checked = [];
var uiConfig = {
    "show_add": false,
    "show_weight": false,
    "show_del": false,
    "show_en": false
};
let allData = globalData;
var myDelete = {};
var groupOrder = [];

function onCheckBoxWeightChange(key, cb, badge, ch) {
    var mW = myWeight[key];
    if (mW == null) {
        mW = 0;
    } else {
        mW = parseInt(mW);
    }
    mW += ch;
    myWeight[key] = mW;
    badge.innerText = mW;

    onCheckBoxChange();
}

function onCheckBoxChange() {
    let a = [];
    let b = [];
    for (var i = 0; i < checkBoxs.length; i++) {
        let cb = checkBoxs[i];
        let info = cb.getAttribute("my_info");
        let group = cb.getAttribute("my_group");
        if (info != null && group != null && cb.checked) {
            let label = cb.getAttribute("my_label");
            let fInfo = info;
            if (label != null) {
                let weight = myWeight[label];
                if (weight != null && weight !== 0) {
                    let neg = weight < 0;
                    let abs = weight < 0 ? (-weight) : weight;
                    for (var j = 0; j < abs; j++) {
                        if (!neg) {
                            fInfo = "{" + fInfo + "}";
                        } else {
                            fInfo = "[" + fInfo + "]";
                        }
                    }
                }
            }
            if (neg.indexOf(group) > -1) {
                b.push(fInfo);
            } else {
                a.push(fInfo);
            }
        }
    }
    let po = a.join(",")
    let ne = b.join(",")
    document.getElementById("textarea_pos").value = po;
    setToWebUiPos("Prompt", po);
    document.getElementById("textarea_neg").value = ne;
    saveChecked();

}

function createTagBtnGroup(key, info, group) {

    let groupLayout = createElement("div", {
        "class": "btn-group tag_btn_group",
        "role": "group",
        "aria-label": "Basic checkbox toggle button group"
    });


    let leftBtn = createElement("button", {
        "type": "button",
        "class": "btn btn-danger",
        "id": "btn_" + key + "_left"
    });
    leftBtn.innerText = "-";

    let rightBtn = createElement("button", {
        "type": "button",
        "class": "btn btn-success",
        "id": "btn_" + key + "_right"
    });
    rightBtn.innerText = "+";


    let checkBtn = createElement("input", {
        "type": "checkbox",
        "class": "btn-check",
        "autocomplete": "off",
        "id": "btn_" + key
        // "data-bs-toggle":"tooltip",
        // "data-bs-placement":"top",
        // "data-bs-title":info
    });

    checkBoxs.push(checkBtn);

    if (checked.indexOf(key) > -1) {
        checkBtn.checked = true;
    }

    let checkLabel = createElement("label", {
        "class": "btn btn-outline-primary",
        "for": "btn_" + key
    });
    if (uiConfig.show_en) {
        checkLabel.innerText = key + "(" + info + ")";
    } else {
        checkLabel.innerText = key;
    }

    let checkBadge = createElement("span", {
        "class": "badge bg-secondary"
    });

    let mW = myWeight[key];
    if (mW != null) {
        checkBadge.innerText = mW;
    } else {
        checkBadge.innerText = 0;
    }
    checkBtn.onclick = onCheckBoxChange;
    leftBtn.onclick = function () {
        onCheckBoxWeightChange(key, checkBtn, checkBadge, -1);
    };
    rightBtn.onclick = function () {
        onCheckBoxWeightChange(key, checkBtn, checkBadge, 1);
    };

    checkBtn.setAttribute("my_label", key);
    checkBtn.setAttribute("my_info", info);
    checkBtn.setAttribute("my_group", group);

    checkLabel.appendChild(checkBadge);
    groupLayout.appendChild(leftBtn);
    groupLayout.appendChild(checkBtn);
    groupLayout.appendChild(checkLabel);
    groupLayout.appendChild(rightBtn);

    if (uiConfig.show_del) {

        let delBtn = createElement("button", {
            "type": "button",
            "class": "btn btn-warning",
            "id": "btn_" + key + "_del"
        });
        delBtn.onclick = function () {

            deleteTag(group, key);
            toast("重新加载后生效", 1000);

        };
        delBtn.innerText = "删除"
        groupLayout.appendChild(delBtn);
    }
    return groupLayout;
}

function isGroupData(group, key) {
    let g = globalData[group];
    if (g == null) return false;
    return g[key] != null;
}

function deleteTag(group, key) {
    let gData = allData[group];
    if (gData != null) {
        let kData = gData[key];
        if (kData != null) {
            Reflect.deleteProperty(gData, key);
            saveStorage(group, gData);

        }
    }
}

/*
   <input type="text" class="form-control" placeholder="Username" aria-label="Username">
                <input type="text" class="form-control" placeholder="Server" aria-label="Server">
                <button type="button" class="btn btn-primary">新增</button>
 */
function createGroupAdd(group) {
    let div = createElement("div", {
        "class": "row"
    });
    let d3 = createElement("div", {
        "class": "input-group mb-3"
    });
    let u1 = createElement("input", {
        "type": "text",
        "class": "form-control",
        "placeholder": "tag名字",
        "aria-label": "tag名字"
    })
    let u2 = createElement("input", {
        "type": "text",
        "class": "form-control",
        "placeholder": "tag内容",
        "aria-label": "tag内容"
    })
    let btn = createElement("button", {
        "type": "button",
        "class": "btn btn-primary"
    });
    btn.innerText = "新增 tag"
    div.appendChild(d3);
    d3.appendChild(u1);
    d3.appendChild(u2);
    d3.appendChild(btn);

    btn.onclick = function () {
        let key = u1.value;
        let gData = allData[group];
        if (key == null || key.length === 0) {
            window.alert("tag内容输入框 为空");
            return
        } else if (gData[key] != null) {
            window.alert("已经存在tag " + key);
            return
        }
        let value = u2.value
        if (value == null || value.length === 0) {
            window.alert("tag内容 为空");
            return
        }
        gData[key] = value;
        saveStorage(group, gData);
        toast("添加成功,重新加载页面后生效", 1000);

    }
    return div;
}

function createTagGroupLayout(group, groupData) {
    let layout = createElement("div", {
        "class": "container-sm"
    });
    let gadd = createGroupAdd(group);
    layout.appendChild(gadd);

    for (let key in groupData) {
        let info = groupData[key];
        let child = createTagBtnGroup(key, info, group);
        layout.appendChild(child)
    }
    return layout

}

function createNavTab(navUl, navContent, tabName, active) {
    let li = createElement("li", {
        "class": "nav-item",
        "role": "presentation"
    });
    let btn = createElement("button", {
        "class": active ? "nav-link active" : "nav-link",
        "id": "tab-" + tabName,
        "data-bs-toggle": "tab",
        "data-bs-target": "#tab_" + tabName,
        "type": "button",
        "role": "tab",
        "aria-controls": "tab_" + tabName,
        "aria-selected": active ? "true" : "false"
    });
    btn.innerText = tabName;
    let tabContent = createElement("div", {
        "class": active ? "tab-pane fade show active" : "tab-pane fade",
        "id": "tab_" + tabName,
        "role": "tabpanel",
        "aria-labelledby": "tab-" + tabName
    });

    li.appendChild(btn);
    navUl.appendChild(li);
    navContent.appendChild(tabContent);

    return tabContent;
}

function toast(text, time) {
    let toast = document.getElementById('toast');
    let toast_box = document.getElementsByClassName('toast_box')[0];
    toast.innerHTML = text;
    toast_box.style.animation = 'show 1.5s';
    toast_box.style.display = 'inline-block';
    setTimeout(function () {
        toast_box.style.animation = 'hide 1.5s';
        setTimeout(function () {
            toast_box.style.display = 'none';
        }, 1400)
    }, time)
}

function copyToClip(content) {
    const inputDom = document.createElement('input');
    inputDom.setAttribute('value', content);
    document.body.appendChild(inputDom);
    inputDom.select();
    document.execCommand('copy');
    document.body.removeChild(inputDom);
    toast("已复制到剪贴板")
}

function resetCheck(resetAll) {
    var checked = localStorage.getItem("checked_data")
    if (checked == null) {
        checked = [];
    }
    for (var i = 0; i < checkBoxs.length; i++) {
        var cb = checkBoxs[i];
        let info = cb.getAttribute("my_label");
        var g = cb.getAttribute("my_group");
        if (g != null && info != null && (!(checked.indexOf(info) > -1) || resetAll)) {
            cb.checked = must.indexOf(g) > -1
        }
    }
    onCheckBoxChange();
}


function loadStorage(key, groupData) {
    var s = localStorage.getItem(key);
    if (s != null) {
        var pData = JSON.parse(s)
        for (let p in pData) {
            let pValue = pData[p];
            groupData[p] = pValue;
        }
    }
}

function saveStorage(key, value) {
    asyncStorage(key, value).then(result => {
    })
}

async function asyncStorage(key, value) {
    var s = JSON.stringify(value);
    localStorage.setItem(key, s);
}

function clearStorage() {
    localStorage.clear()
}

function saveUiConfig() {
    saveStorage("uiConfig", uiConfig);
}

async function loadUiConfig() {
    let s = localStorage.getItem("uiConfig");
    if (s != null) {
        var pData = JSON.parse(s);
        for (let p in pData) {
            let pValue = pData[p];
            uiConfig[p] = pValue;
        }
    }
}

async function loadCheckConfig() {
    checked = localStorage.getItem("checked_data")
    if (checked == null) {
        checked = [];
    }
}

async function loadWeightConfig() {
    loadStorage("myWeight", myWeight);
}

async function loadLocalGroupConfig() {
    for (let group in allData) {
        let value = allData[group];
        loadStorage(group, value);
    }
}

function saveChecked() {
    var checked = [];
    for (var i = 0; i < checkBoxs.length; i++) {
        let cb = checkBoxs[i];
        let info = cb.getAttribute("my_label");
        let group = cb.getAttribute("my_group");
        if (info != null && group != null && cb.checked) {
            checked.push(info);
        }
    }
    saveStorage("checked_data", checked);
    saveStorage("myWeight", myWeight);
}

async function loadGroupOrder() {
   let s = localStorage.getItem("groupOrder");
   if(s!=null){
       groupOrder=JSON.parse(s);
   }
    if (groupOrder == null || groupOrder.length === 0) {
        groupOrder = [];
        for (let p in allData) {
            groupOrder.push(p);
        }
    }
}

function clearGroupOrder() {
    groupOrder = [];
    saveGroupOrder([]);
}

function saveGroupOrder(order) {
    for (let p in order) {
        let data = allData[p];
        if (data == null) {
            allData[p] = {};
        }
    }
    saveStorage("g2",["sss","b"]);
    saveStorage("groupOrder", order);
}


async function loadDelete() {
    myDelete = localStorage.getItem("myDelete");
    if (myDelete == null) {
        myDelete = {};
    }
}

async function loadLocalData() {
    await loadDelete();
    await loadUiConfig();
    await loadCheckConfig();
    await loadWeightConfig();
    await loadLocalGroupConfig();
    await loadGroupOrder();
}

async function clearLocal() {
    localStorage.clear();
}

function configUiCtrl(name) {
    var ctrl1 = document.getElementById(name)
    ctrl1.checked = uiConfig[name];
    ctrl1.onclick = function () {
        uiConfig[name] = ctrl1.checked;
        saveUiConfig();
        toast("点击重新加载后生效", 2000);
    };
}


function modifyGroupData() {
    let data = document.getElementById("textera_group").value;
    if (data == null || data.length === 0) {
        toast("请输入合理的分组列表顺序", 2000);
        return
    }
    let groups=data.split(",")
    if(groups==null || groups.length===0){
        toast("请输入合理的分组列表顺序", 2000);
        return
    }
    if(data.indexOf("，")>-1){
        toast("请不要使用中文逗号", 2000);
        return
    }
    if(data.indexOf(" ")>-1){
        toast("请不要使用空格，使用英文逗号分割", 2000);
        return
    }
    let st=[];
    for(let i in groups){
        let key=groups[i];
        if(key!=null && key.trim().length>0){
            if(st.indexOf(key)>-1){
                toast("存在相同分组 "+key, 2000);
                return;
            }else{
                st.push(key);
            }
            let groupData=groups[i];
            if(groupData==null&&!(key.startsWith("m"))){
                toast("新增的自定义分组 "+key+" 没有以m开头,或者不要修改当前已有的分组名",3000);
                return;
            }
        }

    }
    groupOrder=st;
    saveGroupOrder(st);
    toast("保存分组顺序成功,重新加载页面后生效",2000);
}

function parseAll() {
    let navUi = document.getElementById("myTab");
    let navContent = document.getElementById("myTabContent");

    var active = true;
    for (let i in groupOrder) {
        let group = groupOrder[i];
        if (group != null) {
            let tab = createNavTab(navUi, navContent, group, active);
            active = false;

            let layout = createTagGroupLayout(group, allData[group]);

            tab.appendChild(layout);
        }

    }
    resetCheck(false);


    configUiCtrl("show_en");
    configUiCtrl("show_del");

    document.getElementById("textera_group").value = groupOrder.join(",");
    document.getElementById("btn_group_reset").onclick = function () {
        clearGroupOrder();
        toast("重新加载页面后生效", 2000);
    }
    document.getElementById("btn_group_modify").onclick = modifyGroupData;

    document.getElementById("textarea_pos").onclick = function () {
        copyToClip(document.getElementById("textarea_pos").value)
    };
    document.getElementById("textarea_neg").onclick = function () {
        copyToClip(document.getElementById("textarea_neg").value)
    };
    document.getElementById("btn_reset").onclick = function () {
        resetCheck(true);
    };
    document.getElementById("btn_reload").onclick = function () {
        location.reload();
    };
    document.getElementById("btn_clear").onclick = function () {
        let confirm=window.confirm("删除本地存储可以解决大部分bug，但是意味着分组顺序以及添加tag会被清空")
        if(confirm){
            clearLocal().then(function (p) {
                location.reload();
            })
        }


    };
    onCheckBoxChange();
}

function setToWebUiPos(k, data) {
    // try {
    //     if (chrome == null || chrome.devtools == null) {
    //         toast("null")
    //         return
    //     }
    //
    //
    //
    //     chrome.devtools.inspectedWindow.eval(
    //         "document.getElementById(\"component-30\")",
    //         function (p,ex) {
    //             toast("tag "+ex+" "+p.length);
    //             for(var i=0;i<p.length;i++){
    //
    //                 var textera=p.item(i);
    //                 var tag=textera.getAttribute("placeholder");
    //                 toast("tag "+tag+" "+textera,1000);
    //                 if(tag==k){
    //                     textera.value=data;
    //                 }
    //
    //             }
    //         }
    //     )
    //
    // } catch (e) {
    //
    //     toast("err,"+e)
    // }
}

window.onload = function () {
    loadLocalData().then(p => {
        parseAll();
        // const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        // const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
    })
};